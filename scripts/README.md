# ApprovalFlow - Deployment Scripts

Helper scripts to make Vercel deployment quick and easy.

## Quick Start

### Option 1: Automated Setup (Recommended)

Run the setup script to automatically configure everything:

```bash
./scripts/setup-vercel.sh
```

This script will:
1. Generate JWT secrets
2. Show you which environment variables to add
3. Pull environment variables from Vercel
4. Initialize the database with schema and seed data
5. Optionally trigger a redeploy

**Time: ~10 minutes**

### Option 2: Manual Setup

Follow the detailed guide in `VERCEL_QUICKSTART.md` in the project root.

## Scripts Overview

### `setup-vercel.sh`

**Purpose:** Automated setup for Vercel deployment

**What it does:**
- Generates JWT secrets automatically
- Displays environment variables to add
- Pulls environment from Vercel
- Initializes database schema and seed data
- Optionally triggers redeploy

**Usage:**
```bash
cd /Users/diop/src/experiments/2025-12-09-Approval_Flow
./scripts/setup-vercel.sh
```

**Prerequisites:**
- Vercel CLI installed (`npm install -g vercel`)
- Vercel project created
- Git repository initialized

---

### `test-deployment.sh`

**Purpose:** Verify your Vercel deployment is working correctly

**What it tests:**
- API health endpoint
- Login endpoint functionality
- Actual authentication with test user
- Frontend asset loading
- Authenticated API requests

**Usage:**
```bash
./scripts/test-deployment.sh
```

You'll be prompted to enter your production URL (e.g., `https://approvalflow.vercel.app`)

**When to run:**
- After completing setup and redeploy
- After making changes to verify nothing broke
- Before sharing the app with users

---

## Prerequisites

Before running these scripts, make sure you have:

1. **Vercel CLI installed**
   ```bash
   npm install -g vercel
   ```

2. **Vercel project created**
   - Go to https://vercel.com/dashboard
   - Create new project or import from Git

3. **Neon Postgres added**
   - In Vercel project → Storage tab
   - Add Neon Postgres database
   - This sets DATABASE_URL automatically

4. **Git repository initialized**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   ```

---

## Environment Variables Required

These must be added in **Vercel Dashboard → Settings → Environment Variables**:

### Auto-generated by Scripts:
- `JWT_SECRET` - Generated by setup script
- `JWT_REFRESH_SECRET` - Generated by setup script

### You must add manually:
- `DATABASE_URL` - Auto-set by Neon Postgres integration
- `SENDGRID_API_KEY` - Get from SendGrid (use `SG.temp_key_replace_later` for testing)
- `SENDGRID_FROM_EMAIL` - Your verified sender email (use `noreply@yourdomain.com` for testing)
- `VITE_API_URL` - Set to `/api`

**All variables must be enabled for:** Production, Preview, Development

---

## Troubleshooting

### "Vercel CLI not found"

Install it:
```bash
npm install -g vercel
```

### "DATABASE_URL not found"

Make sure you added Neon Postgres in Vercel:
1. Go to your project
2. Storage tab
3. Create Database → Postgres (Neon)

### "psql: command not found"

Install PostgreSQL client:
```bash
# macOS
brew install postgresql

# Ubuntu/Debian
sudo apt-get install postgresql-client

# Windows
# Download from https://www.postgresql.org/download/windows/
```

### "500 errors on API"

1. Check environment variables are set in Vercel
2. Check Vercel function logs:
   - Deployments tab → Latest deployment
   - Functions tab → Click /api
   - Look for error messages
3. Make sure database is initialized (run setup script)
4. Use production URL, not preview URL

### "401 on manifest.webmanifest"

This happens on preview deployments with Vercel Deployment Protection enabled. Use production URL instead, or disable deployment protection in Settings → Deployment Protection.

---

## Test Users (Created by Seed Script)

After running the setup script, you can login with these users:

| Role | Email | Password |
|------|-------|----------|
| Staff (Chef) | chef@example.com | password123 |
| Manager | manager@example.com | password123 |
| Contrôleur | controleur@example.com | password123 |
| Direction | direction@example.com | password123 |
| Économe | econome@example.com | password123 |

---

## Files Generated

After running the setup script, these files are created:

- `.env.local` - Local environment variables pulled from Vercel
- `.env.secrets.tmp` - Your generated JWT secrets (for reference)

**Security Note:** Both files are already in `.gitignore` and won't be committed.

---

## Next Steps After Setup

1. **Wait for deployment** (~1-2 minutes)
2. **Test with the test script:**
   ```bash
   ./scripts/test-deployment.sh
   ```
3. **Login to your app:**
   - Go to `https://your-project.vercel.app/login`
   - Use: chef@example.com / password123
4. **Optional: Configure real SendGrid:**
   - Sign up at https://sendgrid.com
   - Get API key from Settings → API Keys
   - Update `SENDGRID_API_KEY` in Vercel
   - Update `SENDGRID_FROM_EMAIL` with verified sender
   - Redeploy

---

## Support

For detailed deployment instructions, see:
- `VERCEL_QUICKSTART.md` - Step-by-step manual guide
- `DEPLOYMENT_VERCEL.md` - Comprehensive deployment documentation
- `.env.production.example` - Environment variable reference

For issues, check:
- Vercel function logs
- Vercel build logs
- Browser console (F12 → Console tab)
